<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–í–≥–∞–¥–∞–π –ß–∏—Å–ª–æ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #18181b);
            --tg-text: var(--tg-theme-text-color, #ffffff);
            --tg-hint: var(--tg-theme-hint-color, #9ca3af);
            --tg-button: var(--tg-theme-button-color, #3b82f6);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #27272a);
        }

        body {
            background-color: var(--tg-bg);
            color: var(--tg-text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overscroll-behavior: none;
        }

        .btn {
            @apply w-full text-center py-3 px-4 rounded-xl font-semibold transition-transform duration-200 active:scale-95 shadow-lg;
        }

        .btn-primary {
            background-color: var(--tg-button);
            color: var(--tg-button-text);
        }

        .btn-secondary {
            background-color: var(--tg-secondary-bg);
            color: var(--tg-text);
        }

        .btn-danger {
            @apply bg-red-600 text-white;
        }

        .input-field {
            @apply w-full border-2 rounded-xl text-center text-3xl tracking-[0.2em] p-4 outline-none transition-colors;
            background-color: var(--tg-secondary-bg);
            border-color: transparent;
        }

        .input-field:focus {
            border-color: var(--tg-button);
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fade-in 0.3s ease-out;
        }

        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-sm mx-auto">
        <div id="loading-screen" class="screen active text-center">
            <h1 class="text-2xl font-bold">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≥—Ä–∏...</h1>
        </div>

        <div id="error-screen" class="screen">
            <div class="p-6 rounded-xl text-center" style="background-color: var(--tg-secondary-bg);">
                <h1 class="text-2xl font-bold mb-2">üö´ –ü–æ–º–∏–ª–∫–∞</h1>
                <p style="color: var(--tg-hint);">–¶–µ–π –¥–æ–¥–∞—Ç–æ–∫ –º–æ–∂–Ω–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –ª–∏—à–µ —á–µ—Ä–µ–∑ –∫–ª—ñ—î–Ω—Ç Telegram.</p>
            </div>
        </div>

        <div id="main-menu" class="screen space-y-4">
            <div class="text-center mb-6">
                <h1 class="text-4xl font-bold">üéØ –í–≥–∞–¥–∞–π –ß–∏—Å–ª–æ</h1>
                <p style="color: var(--tg-hint);">–ü–µ—Ä–µ–≤—ñ—Ä —Å–≤–æ—é —ñ–Ω—Ç—É—ó—Ü—ñ—é</p>
            </div>
            <button class="btn btn-primary" onclick="createLobby()">üë• –°—Ç–≤–æ—Ä–∏—Ç–∏ –≥—Ä—É</button>
            <button class="btn btn-secondary" onclick="showScreen('join-lobby')">üö™ –ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è</button>
            <button class="btn btn-secondary" onclick="startPractice()">ü§ñ –¢—Ä–µ–Ω—É–≤–∞–Ω–Ω—è –∑ –±–æ—Ç–æ–º</button>
        </div>

        <div id="waiting-lobby" class="screen text-center space-y-4">
            <h1 class="text-2xl font-bold">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –≥—Ä–∞–≤—Ü—è...</h1>
            <div class="p-4 rounded-lg" style="background-color: var(--tg-secondary-bg);">
                <p class="text-sm" style="color: var(--tg-hint);">–ö–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏:</p>
                <p id="lobby-id-display" class="font-mono text-xl break-all"></p>
            </div>
            <p style="color: var(--tg-hint);">–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è –∫–æ–¥–æ–º –∑ –¥—Ä—É–≥–æ–º –∞–±–æ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ.</p>
            <button class="btn btn-primary" onclick="shareInvite()">üîó –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è–º</button>
            <button class="btn btn-danger" onclick="leaveLobby()">üö™ –ü–æ–∫–∏–Ω—É—Ç–∏ –∫—ñ–º–Ω–∞—Ç—É</button>
        </div>

        <div id="join-lobby" class="screen space-y-4">
            <h1 class="text-2xl font-bold text-center">–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è –¥–æ –≥—Ä–∏</h1>
            <input type="text" id="lobby-code-input" class="input-field" placeholder="–ö–û–î –ö–Ü–ú–ù–ê–¢–ò">
            <button class="btn btn-primary" onclick="joinLobby()">üöÄ –£–≤—ñ–π—Ç–∏</button>
            <button class="btn btn-secondary" onclick="showScreen('main-menu')">‚Üê –ù–∞–∑–∞–¥</button>
        </div>

        <div id="set-secret" class="screen space-y-4 text-center">
            <h1 class="text-2xl font-bold">üîí –í–∞—à–µ —á–∏—Å–ª–æ</h1>
            <p style="color: var(--tg-hint);">–ó–∞–≥–∞–¥–∞–π—Ç–µ 4-–∑–Ω–∞—á–Ω–µ —á–∏—Å–ª–æ –∑ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–º–∏ —Ü–∏—Ñ—Ä–∞–º–∏ (–Ω–µ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ 0).</p>
            <input type="text" id="secret-number-input" class="input-field" placeholder="1234" maxlength="4"
                inputmode="numeric">
            <div id="secret-status" class="pt-2 text-sm" style="color: var(--tg-hint);"></div>
            <button class="btn btn-primary" onclick="setSecretNumber()">‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏</button>
        </div>

        <div id="game-play" class="screen space-y-4">
            <div id="turn-indicator" class="text-center text-lg font-semibold p-3 rounded-xl"></div>
            <input type="text" id="guess-input" class="input-field" placeholder="...." maxlength="4"
                inputmode="numeric">
            <button id="guess-btn" class="btn btn-primary" onclick="makeGuess()">üéØ –í–≥–∞–¥–∞—Ç–∏</button>

            <div class="space-y-2 pt-4">
                <h3 class="text-lg font-bold text-center">–Ü—Å—Ç–æ—Ä—ñ—è —Ö–æ–¥—ñ–≤</h3>
                <div id="guess-history" class="h-48 overflow-y-auto p-3 rounded-lg space-y-2"
                    style="background-color: var(--tg-secondary-bg);"></div>
            </div>
            <button class="btn btn-danger" onclick="surrenderGame()">üè≥Ô∏è –ó–¥–∞—Ç–∏—Å—è</button>
        </div>

        <div id="game-result" class="screen text-center space-y-4">
            <h1 id="result-title" class="text-4xl font-bold"></h1>
            <p id="result-description" style="color: var(--tg-hint);"></p>
            <div class="p-4 rounded-lg" style="background-color: var(--tg-secondary-bg);">
                <p>–°–µ–∫—Ä–µ—Ç–Ω–µ —á–∏—Å–ª–æ –æ–ø–æ–Ω–µ–Ω—Ç–∞:</p>
                <p id="opponent-secret-number" class="font-bold text-3xl tracking-widest text-sky-400"></p>
            </div>
            <button class="btn btn-primary" onclick="showScreen('main-menu'); requestStateUpdate();">üè† –ì–æ–ª–æ–≤–Ω–µ
                –º–µ–Ω—é</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram ? window.Telegram.WebApp : null;

        const screens = {
            loading: document.getElementById('loading-screen'),
            error: document.getElementById('error-screen'),
            mainMenu: document.getElementById('main-menu'),
            waiting: document.getElementById('waiting-lobby'),
            join: document.getElementById('join-lobby'),
            setSecret: document.getElementById('set-secret'),
            gamePlay: document.getElementById('game-play'),
            gameResult: document.getElementById('game-result'),
        };

        function showScreen(screenId) {
            if (!tg) {
                Object.values(screens).forEach(s => s.classList.remove('active'));
                screens.error.classList.add('active');
                return;
            }
            Object.values(screens).forEach(s => s.classList.remove('active'));
            const screenKey = Object.keys(screens).find(key => screens[key].id === screenId);
            if (screens[screenKey]) {
                screens[screenKey].classList.add('active');
            } else {
                console.error(`Screen with id ${screenId} not found.`);
                screens.mainMenu.classList.add('active');
            }
            tg.HapticFeedback.impactOccurred('light');
        }

        function updateUI(state) {
            if (!state || !state.status || state.status === 'not_in_game') {
                showScreen('main-menu');
                return;
            }

            switch (state.status) {
                case 'waiting_for_player':
                    document.getElementById('lobby-id-display').textContent = state.lobbyId;
                    showScreen('waiting-lobby');
                    break;
                case 'setting_secret':
                    document.getElementById('secret-status').textContent = state.waitingForOpponentSecret ? '–û—á—ñ–∫—É—î–º–æ, –ø–æ–∫–∏ –æ–ø–æ–Ω–µ–Ω—Ç –∑–∞–≥–∞–¥–∞—î —á–∏—Å–ª–æ...' : '–ó–∞–≥–∞–¥–∞–π—Ç–µ –≤–∞—à–µ —Å–µ–∫—Ä–µ—Ç–Ω–µ —á–∏—Å–ª–æ.';
                    showScreen('set-secret');
                    break;
                case 'in_game':
                    updateGamePlayUI(state);
                    showScreen('game-play');
                    break;
                case 'game_over':
                    updateGameResultUI(state);
                    showScreen('game-result');
                    break;
                default:
                    showScreen('main-menu');
            }
        }

        function updateGamePlayUI(state) {
            const turnIndicator = document.getElementById('turn-indicator');
            const guessBtn = document.getElementById('guess-btn');
            const guessInput = document.getElementById('guess-input');

            if (state.isMyTurn) {
                turnIndicator.textContent = "üéØ –í–∞—à —Ö—ñ–¥!";
                turnIndicator.className = 'text-center text-lg font-semibold p-3 rounded-xl bg-green-500/20 text-green-300';
                guessBtn.disabled = false;
                guessInput.disabled = false;
            } else {
                turnIndicator.textContent = "‚è≥ –•—ñ–¥ –æ–ø–æ–Ω–µ–Ω—Ç–∞...";
                turnIndicator.className = 'text-center text-lg font-semibold p-3 rounded-xl bg-yellow-500/20 text-yellow-300';
                guessBtn.disabled = true;
                guessInput.disabled = true;
            }

            const historyContainer = document.getElementById('guess-history');
            historyContainer.innerHTML = '';
            if (state.history && Array.isArray(state.history)) {
                state.history.slice().reverse().forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'p-3 rounded-md';
                    historyItem.style.backgroundColor = 'rgba(0,0,0,0.2)';
                    historyItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="text-xl font-mono tracking-widest">${item.guess}</span>
                        <div class="text-right text-sm">
                            <p>–ó–±—ñ–≥—ñ–≤: <span class="font-bold">${item.sameDigits}</span></p>
                            <p>–ù–∞ –º—ñ—Å—Ü—ñ: <span class="font-bold">${item.samePositions}</span></p>
                        </div>
                    </div>
                `;
                    historyContainer.appendChild(historyItem);
                });
            }
        }

        function updateGameResultUI(state) {
            document.getElementById('result-title').textContent = state.win ? "üèÜ –ü–µ—Ä–µ–º–æ–≥–∞! üèÜ" : "üòî –ü–æ—Ä–∞–∑–∫–∞ üòî";
            document.getElementById('result-description').textContent = state.message;
            document.getElementById('opponent-secret-number').textContent = state.opponentSecretNumber;
        }

        function sendData(data) {
            try {
                if (!tg || !tg.initData) {
                    console.error("Telegram WebApp is not initialized.");
                    showScreen('error-screen');
                    return;
                }
                console.log("Sending data:", data);
                tg.sendData(JSON.stringify(data));
            } catch (e) {
                console.error("Error sending data:", e);
            }
        }

        function requestStateUpdate() {
            sendData({ action: 'get_game_state' });
        }

        function shareInvite() {
            try {
                const lobbyId = document.getElementById('lobby-id-display').textContent;
                tg.switchInlineQuery(lobbyId, ['users', 'groups']);
            } catch (e) {
                console.error("Sharing is not available on this platform", e);
                tg.showAlert("Sharing is not available on your device.");
            }
        }

        const createLobby = () => sendData({ action: 'create_lobby' });
        const startPractice = () => sendData({ action: 'start_practice' });
        const leaveLobby = () => sendData({ action: 'leave_lobby' });
        const surrenderGame = () => tg.showConfirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –∑–¥–∞—Ç–∏—Å—è?", (ok) => ok && sendData({ action: 'surrender' }));

        function joinLobby() {
            const lobbyId = document.getElementById('lobby-code-input').value.trim();
            if (!lobbyId) {
                tg.showAlert("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏.");
                return;
            }
            sendData({ action: 'join_lobby', lobbyId });
        }

        function setSecretNumber() {
            const number = document.getElementById('secret-number-input').value;
            if (!/^[1-9]\d{3}$/.test(number) || new Set(number).size !== 4) {
                tg.showAlert('–ß–∏—Å–ª–æ –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ 4 —É–Ω—ñ–∫–∞–ª—å–Ω—ñ —Ü–∏—Ñ—Ä–∏ —ñ –Ω–µ –ø–æ—á–∏–Ω–∞—Ç–∏—Å—å –∑ 0.');
                return;
            }
            sendData({ action: 'set_secret', secretNumber: number });
            document.getElementById('secret-status').textContent = '–ß–∏—Å–ª–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ. –û—á—ñ–∫—É—î–º–æ –Ω–∞ –æ–ø–æ–Ω–µ–Ω—Ç–∞...';
        }

        function makeGuess() {
            const guess = document.getElementById('guess-input').value;
            if (!/^[1-9]\d{3}$/.test(guess) || new Set(guess).size !== 4) {
                tg.showAlert('–í–≤–µ–¥—ñ—Ç—å 4 —É–Ω—ñ–∫–∞–ª—å–Ω—ñ —Ü–∏—Ñ—Ä–∏, —â–æ –Ω–µ –ø–æ—á–∏–Ω–∞—é—Ç—å—Å—è –∑ 0.');
                return;
            }
            sendData({ action: 'make_guess', guess });
            document.getElementById('guess-input').value = '';
        }

        function initializeApp() {
            if (!tg || !tg.initData) {
                showScreen('error-screen');
                return;
            }

            try {
                tg.ready();
                tg.expand();
                tg.setHeaderColor(getComputedStyle(document.documentElement).getPropertyValue('--tg-secondary-bg').trim());
                tg.setBackgroundColor(getComputedStyle(document.documentElement).getPropertyValue('--tg-bg').trim());

                tg.onEvent('message', (event) => {
                    try {
                        const state = JSON.parse(event.data);
                        console.log("Received state:", state);
                        updateUI(state);
                    } catch (e) {
                        console.error("Failed to parse state:", e, event);
                    }
                });

                tg.onEvent('viewportChanged', (event) => {
                    if (event.isStateStable) {
                        requestStateUpdate();
                    }
                });

                const startParam = tg.initDataUnsafe.start_param;
                if (startParam) {
                    showScreen('join-lobby');
                    document.getElementById('lobby-code-input').value = startParam;
                    joinLobby();
                } else {
                    requestStateUpdate();
                }

            } catch (e) {
                console.error("Initialization failed:", e);
                showScreen('error-screen');
            }
        }

        window.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>

</html>